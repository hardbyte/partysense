<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCjOEItJV2ny3PQzAB6jeoQztOHvqBnQ_I&sensor=false">
</script>

<script type="text/javascript">
    var geocoder = new google.maps.Geocoder();
    //
    var base_point = new google.maps.LatLng({{ base_point }});

    var map, my_point;

    /* Try to center the map on user's address. */
    geocoder.geocode( { 'address': "{{ country_city }}" }, function(results, status) {
        if (status == google.maps.GeocoderStatus.OK) {
            base_point = results[0].geometry.location;

            // force move
            set_center(base_point.lat(), base_point.lng())
        }
    });


    $(document).ready(function(){
        if($('#id_latitude').val()!=''){
            center = new google.maps.LatLng($('#id_latitude').val(), $('#id_longitude').val());
        }else{
            center = base_point
        }
        var myOptions = {
            zoom: 15,
            center: center,
            mapTypeId: google.maps.MapTypeId.ROADMAP
        };

        map = new google.maps.Map(document.getElementById("map_canvas"), myOptions);

        my_point = new google.maps.Marker({
            position: center,
            map: map,
            draggable: true
        });

        google.maps.event.addListener(my_point, 'dragend', function(event){
            $('#id_latitude').val(event.latLng.lat());
            $('#id_longitude').val(event.latLng.lng());
        });

    });

    function codeAddress(){
        var address = $('#id_address').val() + ', ' + $('#city_country').val();
        console.log("Asking google where to find: " + address);
        geocoder.geocode( { 'address': address}, function(results, status) {
            if (status == google.maps.GeocoderStatus.OK) {
                var results_len = results.length;

                var results_table = new Array();
                //console.log("Found " + results_len + " results!");
                for(i=0; i<results_len; i++){
                    var address_location = results[i].geometry.location

                    if(i === 0){
                        console.log("Found address: " + address_location);
                        //map.setCenter(address_location);
                        set_center(address_location.lat(), address_location.lng())
                    } else {
                        // Display the results as a basic list
                        results_table[i] = '<div style="cursor: pointer" onclick="set_center(' +
                            address_location.lat() + ', ' +
                            address_location.lng() + ')">' +
                            results[i].formatted_address +
                            '</div>';
                        }
                }
                $('#search_results').html(results_table.join(''));
            } else {
                alert("Geocode was not successful for the following reason: " + status);
            }
        });
    }

    function set_center(lat, lng){
        latlng = new google.maps.LatLng(lat, lng);
        my_point.setPosition(latlng)
        map.setCenter(latlng);

        // Save this as our location
        $('#id_latitude').val(lat);
        $('#id_longitude').val(lng);
        $('#id_venue').val($('#id_address').val());
    }

</script>
<div>
    <div class="address_input">
        <input id="id_address" type="text" value="" placeholder="Venue" />
        <input id="city_country" type="text" value="{{ country_city }}" />

        <input type="button" value="Find" onclick="codeAddress()" />
        <br style="clear: both" />
        <div id="search_results">
        </div>
    </div>
    <div id="map_canvas" style="width: {{ width }}px; height: {{ height }}px;"></div>
</div>