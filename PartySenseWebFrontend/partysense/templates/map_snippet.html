<script src="https://maps.googleapis.com/maps/api/js?libraries=places&key=AIzaSyCjOEItJV2ny3PQzAB6jeoQztOHvqBnQ_I&sensor=false">
</script>

<script type="text/javascript">
    var geocoder = new google.maps.Geocoder();

    var base_point = new google.maps.LatLng({{ base_point }});

    var map, my_point;

    /* Try to center the map on user's city. */
    geocoder.geocode( { 'address': "{{ country_city }}" }, function(results, status) {
        if (status == google.maps.GeocoderStatus.OK) {
            base_point = results[0].geometry.location;

            if($('#id_latitude').val() == '')
            {
                // force move
                set_center(base_point.lat(), base_point.lng())
            }
        }
    });


    $(document).ready(function(){
        $('#id_address').keydown(function (event) {
            var keypressed = event.keyCode || event.which;
            if (keypressed == 13) {
                entrySelected();
                return false;
            }
            return true;
        });

        // If we are editing the form the id_venue will be set by the server
        $('#id_address').val($('#id_venue').val());

        $('#id_address').change(function(){
            $('#id_venue').val($('#id_address').val());
        });


        if($('#id_latitude').val()!=''){
            center = new google.maps.LatLng($('#id_latitude').val(), $('#id_longitude').val());
        }else{
            center = base_point
        }

        var myOptions = {
            zoom: 15,
            center: center,
            mapTypeId: google.maps.MapTypeId.ROADMAP
        };
        google.maps.visualRefresh = true;
        map = new google.maps.Map(document.getElementById("map_canvas"), myOptions);

        my_point = new google.maps.Marker({
            position: center,
            map: map,
            draggable: true
        });

        google.maps.event.addListener(my_point, 'dragend', function(event){
            $('#id_latitude').val(event.latLng.lat());
            $('#id_longitude').val(event.latLng.lng());
        });

        var input = document.getElementById('id_address');
        var defaultBounds = new google.maps.LatLngBounds(
          new google.maps.LatLng(center.lat()-10, center.lng()-10),
          new google.maps.LatLng(center.lat()+10, center.lng()+10));

        var options = {
            bounds: defaultBounds
            //types: ['establishment']
        };

        autocomplete = new google.maps.places.Autocomplete(input, options);
        google.maps.event.addListener(autocomplete, 'place_changed', function(){
            var selectedPlace = autocomplete.getPlace();
            if(!selectedPlace.geometry){
                alert("Place not found");

            } else {
                console.log("Lat: " + selectedPlace.geometry.location.lat() + ", Long: " + selectedPlace.geometry.location.lng() )
                set_center(selectedPlace.geometry.location.lat(),selectedPlace.geometry.location.lng());

            }
        });
    });

    function entrySelected(){
        console.log("Entry Selected")
    }

    function set_center(lat, lng){
        var latlng = new google.maps.LatLng(lat, lng);
        my_point.setPosition(latlng);
        map.setCenter(latlng);
        // Save this as our location
        $('#id_latitude').val(lat);
        $('#id_longitude').val(lng);
    }



</script>
<div>
    <div class="address_input input-group">
        <input id="id_address" type="text" value="" class="textinput form-control" placeholder="Address" />
        <br style="clear: both" />
        <div id="search_results">
        </div>

    </div>
    <p style="margin: 15px;"></p>
    <div id="map_canvas" style="width: 100%; height: {{ height }}px;"></div>
</div>